<div class="container py-4 rtl">
    <div *ngIf="loading" class="loading-state">
        <div class="spinner-container">
            <div class="spinner-wrapper">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">جار التحميل...</span>
                </div>
            </div>
            <div class="loading-text">
                <h5>جارٍ تحميل تفاصيل القرار...</h5>
                <p class="text-muted">قد تستغرق العملية بضع ثوانٍ</p>
            </div>
        </div>
    </div>

    <div *ngIf="!loading && !letter" class="empty-state">
        <div class="empty-icon">
            <i class="fa fa-file-search"></i>
        </div>
        <h4 class="empty-title">القرار غير موجود</h4>
        <p class="empty-text text-muted">تعذر العثور على القرار المطلوب في الأرشيف</p>
    </div>

    <div *ngIf="!loading && letter" class="letter-detail">
        <div class="detail-header">
            <div class="header-badges">
                <div class="letter-priority" *ngIf="letter.priority" [ngClass]="getPriorityClass(letter.priority)">
                    <i class="fa" [ngClass]="getPriorityIcon(letter.priority)"></i>
                    {{ getPriorityText(letter.priority) }}
                </div>
                <div class="letter-number" *ngIf="letter.transactionNumber">
                    <i class="fa fa-hashtag me-1"></i>
                    رقم المعاملة: {{ letter.transactionNumber }}
                </div>
                <button *ngIf="showPdfButton()" class="btn btn-pdf" (click)="openPdf()" [disabled]="pdfLoading">
                    <i class="fa" [ngClass]="pdfLoading ? 'fa-spinner fa-spin' : 'fa-file-pdf'"></i>
                    {{ pdfLoading ? 'جاري التحميل...' : 'عرض PDF' }}
                </button>
            </div>

            <div class="header-content">
                <h1 class="letter-title">{{ letter.title }}</h1>
            </div>
        </div>

        <div class="detail-content">
            <div class="content-section" *ngIf="letter.Rationale" id="rationale">
                <h3 class="section-title">
                    <i class="fa fa-lightbulb me-2"></i>الحيثيات
                </h3>
                <div class="section-content">
                    <div class="rationale-content">
                        {{ letter.Rationale }}
                    </div>
                </div>
            </div>

            <div class="content-section" *ngIf="letter.description || letter.breeif" id="description">
                <h3 class="section-title">
                    <i class="fa fa-file-alt me-2"></i>
                    {{ letter.breeif ? 'الوصف المختصر' : 'وصف القرار' }}
                </h3>
                <div class="section-content description-content"
                    [innerHTML]="formatDescription(letter.description || letter.breeif)"></div>
            </div>


            <div class="content-section" *ngIf="letter.decision" id="decision">
                <h3 class="section-title">
                    <i class="fa fa-file-contract me-2"></i>معلومات القرار
                </h3>
                <div class="section-content">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fa fa-heading"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">نوع القرار:</span>
                                <span class="info-value">{{ letter.decision.title }}</span>
                            </div>
                        </div>
                        <div class="info-item" *ngIf="letter.decision.sector">
                            <div class="info-icon">
                                <i class="fa fa-building"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">الجهه:</span>
                                <span class="info-value">{{ getSectorName(letter.decision.sector) }}</span>
                            </div>
                        </div>

                        <div class="info-item" *ngIf="letter.decision.supervisor">
                            <div class="info-icon">
                                <i class="fa fa-user-shield"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">الجهه المراجعه:</span>
                                <span class="info-value">{{ getSupervisorName(letter.decision.supervisor.fullname)
                                    }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم المرفقات مع زر الرفع -->
            <div class="content-section" id="attachments">
                <h3 class="section-title">
                    <i class="fa fa-paperclip me-2"></i>المرفقات
                </h3>
                <div class="section-content">
                    <!-- إذا كان هناك مرفق -->
                    <div *ngIf="letter.attachment" class="attachment-card">
                        <div class="attachment-info">
                            <div class="attachment-icon">
                                <i class="fa" [ngClass]="getFileIcon(letter.attachment)"></i>
                            </div>
                            <div class="attachment-details">
                                <div class="attachment-name">{{ getFileName(letter.attachment) }}</div>
                                <div class="attachment-meta">
                                    <span><i class="fa fa-calendar me-1"></i>تم الرفع في {{ letter.createdAt | date:
                                        'dd/MM/yyyy' }}</span>
                                    <span *ngIf="getFileSize(letter.attachment)"><i class="fa fa-hdd me-1"></i>{{
                                        getFileSize(letter.attachment) }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="attachment-actions">
                            <a [href]="getAttachmentUrl(letter.attachment)" target="_blank"
                                class="btn btn-outline-primary me-2">
                                <i class="fa fa-eye me-2"></i>عرض
                            </a>
                            <a [href]="getDownloadUrl(letter.attachment)" download class="btn btn-primary">
                                <i class="fa fa-download me-2"></i>تحميل
                            </a>
                        </div>
                    </div>

                    <!-- إذا لم يكن هناك مرفق -->
                    <div *ngIf="!letter.attachment" class="empty-attachment text-center py-4">
                        <i class="fa fa-file-upload text-muted mb-3" style="font-size: 3rem;"></i>
                        <p class="text-muted">لا توجد مرفقات لهذا القرار</p>
                    </div>

                    <!-- زر رفع ملف جديد - ظاهر دائماً -->
                    <button class="btn btn-warning mt-3" (click)="openUploadModal()">
                        <i class="fa fa-upload me-2"></i>
                        {{ letter.attachment ? 'استبدال الملف' : 'رفع ملف جديد' }}
                    </button>
                </div>
            </div>

            <div class="content-section" *ngIf="letter.StartDate || letter.EndDate" id="timeline">
                <h3 class="section-title">
                    <i class="fa fa-calendar-alt me-2"></i>الجدول الزمني
                </h3>
                <div class="section-content">
                    <div class="timeline-info">
                        <div class="info-item" *ngIf="letter.decision.createdAt">
                            <div class="info-icon">
                                <i class="fa fa-calendar-plus"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">تاريخ إنشاء القرار:</span>
                                <span class="info-value">{{ letter.decision.createdAt | date: 'dd/MM/yyyy' }}</span>
                            </div>
                        </div>
                        <div class="info-item" *ngIf="letter.StartDate">
                            <div class="info-icon">
                                <i class="fa fa-play-circle"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">تاريخ البدء:</span>
                                <span class="info-value">{{ letter.StartDate | date: 'dd/MM/yyyy' }}</span>
                            </div>
                        </div>
                        <div class="info-item" *ngIf="letter.EndDate">
                            <div class="info-icon">
                                <i class="fa fa-flag-checkered"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">تاريخ الانتهاء:</span>
                                <span class="info-value">{{ letter.EndDate | date: 'dd/MM/yyyy' }}</span>
                            </div>
                        </div>
                        <div class="info-item" *ngIf="letter.StartDate && letter.EndDate">
                            <div class="info-icon">
                                <i class="fa fa-clock"></i>
                            </div>
                            <div class="info-content">
                                <span class="info-label">مده سريان القرار:</span>
                                <span class="info-value">{{ calculateDuration(letter.StartDate, letter.EndDate)
                                    }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-section" *ngIf="letter.approvals && letter.approvals.length > 0" id="approvals">
                <h3 class="section-title">
                    <i class="fa fa-check-circle me-2"></i>مسار القرار
                    <span class="approvals-count">{{ letter.approvals.length }}</span>
                </h3>
                <div class="section-content">
                    <div class="approvals-timeline">
                        <div class="timeline-line"></div>
                        <div class="approval-item" *ngFor="let approval of letter.approvals; let i = index"
                            [ngClass]="{'first-item': i === 0, 'last-item': i === letter.approvals.length - 1}">
                            <div class="approval-badge" [ngClass]="approval.approved ? 'approved' : 'rejected'">
                                <i class="fa" [ngClass]="approval.approved ? 'fa-check' : 'fa-times'"></i>
                            </div>
                            <div class="approval-content">
                                <div class="approval-header">
                                    <div class="approval-role-container">
                                        <span class="approval-role">{{ getRoleText(approval.role) }}</span>
                                        <span class="approval-step">الخطوة {{ i + 1 }}</span>
                                    </div>
                                    <span class="approval-date">{{ approval.date | date: 'dd/MM/yyyy - hh:mm a'
                                        }}</span>
                                </div>
                                <div class="approval-status"
                                    [ngClass]="approval.approved ? 'status-approved' : 'status-rejected'">
                                    <i class="fa me-1"
                                        [ngClass]="approval.approved ? 'fa-check-circle' : 'fa-times-circle'"></i>
                                    {{ approval.approved ? 'تمت الموافقة' : 'تم الرفض' }}
                                </div>
                                <div class="approval-user" *ngIf="approval.userId">
                                    <i class="fa fa-user me-1"></i>
                                    {{ getUserName(approval.userId) }}
                                </div>
                                <div class="approval-notes" *ngIf="approval.notes">
                                    <strong>ملاحظات:</strong> {{ approval.notes }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="custom-modal" [class.show]="showUploadModal" id="uploadModal">
    <div class="modal-content">
        <h4 class="mb-3">رفع ملف جديد</h4>

        <input type="file" (change)="selectNewFile($event)" class="form-control" />

        <div class="text-end mt-3">
            <button class="btn btn-secondary me-2" (click)="closeUploadModal()">إلغاء</button>
            <button class="btn btn-primary" (click)="uploadNewFile()">رفع</button>
        </div>
    </div>
</div>