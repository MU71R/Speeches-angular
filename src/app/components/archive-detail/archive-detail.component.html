<div class="container-fluid rtl" dir="rtl">
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col-12 col-md-8 col-lg-9">
        <div class="d-flex align-items-center mb-2 mb-md-0">
          <div class="flex-grow-1 min-width-0">
            <h1 class="page-title text-truncate">{{ getArchiveTitle() }}</h1>
            <p class="page-subtitle text-truncate mb-0">{{ getArchiveSubtitle() }}</p>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4 col-lg-3">
        <button class="btn btn-light btn-add" *ngIf="user?.role === 'UniversityPresident' || user?.fullname === 'مكتب رئيس الجامعة'" (click)="openUploadModal()" [disabled]="loading">
          <i class="fa fa-plus-circle me-2"></i>
          <span class="d-none d-sm-inline">إضافة مستند جديد</span>
          <span class="d-inline d-sm-none">إضافة</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ======= Filters Section ======= -->
  <div *ngIf="!loading && letters.length > 0" class="filters-section mb-4">
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-12 col-md-4">
            <label class="form-label fw-semibold">بحث في القرارات</label>
            <div class="search-input-group">
              <input type="text" class="form-control" placeholder="ابحث في العناوين، الجهات ..."
                [(ngModel)]="searchTerm" (input)="applyFilters()" />
              <i class="fa fa-search search-icon"></i>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-md-2">
            <label class="form-label fw-semibold">من تاريخ</label>
            <input type="date" class="form-control" [(ngModel)]="filters.fromDate" (change)="applyFilters()" />
          </div>

          <div class="col-12 col-sm-6 col-md-2">
            <label class="form-label fw-semibold">إلى تاريخ</label>
            <input type="date" class="form-control" [(ngModel)]="filters.toDate" (change)="applyFilters()" />
          </div>

          <div class="col-12 col-sm-6 col-md-2">
            <label class="form-label fw-semibold">الجهه</label>
            <select class="form-select" [(ngModel)]="filters.sender" (change)="applyFilters()">
              <option value="">جميع الجهات</option>
              <option *ngFor="let sender of uniqueSenders" [value]="sender">{{ sender }}</option>
            </select>
          </div>

          <div class="col-12 col-sm-6 col-md-2">
            <label class="form-label fw-semibold">تاريخ بدء القرار</label>
            <input type="date" class="form-control" [(ngModel)]="dateRange.startDate" (change)="applyFilters()" />
          </div>

          <div class="col-12 col-sm-6 col-md-2">
            <label class="form-label fw-semibold">تاريخ انتهاء القرار</label>
            <input type="date" class="form-control" [(ngModel)]="dateRange.endDate" (change)="applyFilters()" />
          </div>

          <div class="col-12 col-sm-6 col-md-2">
            <div class="d-flex gap-2">
              <button class="btn btn-outline-secondary w-100" (click)="resetFilters()" title="إعادة تعيين الفلاتر">
                <i class="fa fa-refresh"></i>
                <span class="d-none d-md-inline ms-1">إعادة تعيين</span>
              </button>
            </div>
          </div>
        </div>

        <div class="row mt-3" *ngIf="filteredLetters.length !== letters.length">
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between">
              <div class="results-info">
                <span class="badge bg-primary">
                  عرض {{ filteredLetters.length }} من أصل {{ letters.length }}
                </span>
              </div>
              <button class="btn btn-sm btn-outline-secondary" (click)="resetFilters()">
                إظهار الكل
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======== Loading ======== -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner-container">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
      <div class="loading-text">
        <h4>جاري تحميل البيانات</h4>
        <p class="text-muted">يرجى الانتظار...</p>
      </div>
    </div>
  </div>

  <!-- ======== Empty State ======== -->
  <div *ngIf="!loading && filteredLetters.length === 0" class="empty-state">
    <div class="empty-icon">
      <i class="fa" [class.fa-inbox]="letters.length === 0" [class.fa-search]="letters.length > 0"></i>
    </div>
    <h3 class="empty-title">
      {{ letters.length === 0 ? 'لا توجد قرارات' : 'لم يتم العثور على نتائج' }}
    </h3>
    <p class="empty-text">
      {{ letters.length === 0 ? 'لم يتم العثور على أي قرارات في هذا الأرشيف.' : 'لمطابقة معايير البحث المحددة.' }}
    </p>
    <button
      *ngIf="isSpecialArchive() || letters.length === 0"
      class="btn btn-primary"
      (click)="openUploadModal()"
    >
      <i class="fa fa-plus me-2"></i>إضافة أول قرار
    </button>
    <button *ngIf="letters.length > 0" class="btn btn-outline-primary" (click)="resetFilters()">
      <i class="fa fa-refresh me-2"></i>عرض جميع القرارت
    </button>
  </div>

  <!-- ======== Letters Table ======== -->
  <div *ngIf="!loading && filteredLetters.length > 0" class="letters-table-container">
    <div class="table-responsive">
      <table class="table table-hover table-striped letters-table">
        <thead class="table-primary">
          <tr>
            <th scope="col" width="5%">#</th>
            <th scope="col" width="20%">
              <div class="d-flex align-items-center cursor-pointer" (click)="sortBy('title')">
                عنوان القرار
              </div>
            </th>
            <th scope="col" width="15%">
              <div class="d-flex align-items-center cursor-pointer" (click)="sortBy('user.fullname')">
                الجهه
              </div>
            </th>
            <th scope="col" width="15%">
              <div class="d-flex align-items-center cursor-pointer" (click)="sortBy('createdAt')">
                تاريخ الإنشاء
                <i class="fa ms-1" [class.fa-sort]="sortField !== 'createdAt'"
                  [class.fa-sort-up]="sortField === 'createdAt' && sortDirection === 'asc'"
                  [class.fa-sort-down]="sortField === 'createdAt' && sortDirection === 'desc'"></i>
              </div>
            </th>
            <th scope="col" width="10%">تاريخ بدء القرار</th>
            <th scope="col" width="10%">تاريخ انتهاء القرار</th>
            <th scope="col" width="10%">الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let letter of filteredLetters; let i = index; trackBy: trackByLetterId" class="letter-row">
            <td data-label="#">
              <span class="badge bg-primary">{{ (currentPage - 1) * pageSize + i + 1 }}</span>
            </td>
            <td data-label="عنوان القرار">
              <div class="letter-title-cell">
                <i class="fa fa-envelope text-primary me-2"></i>
                <div class="letter-content">
                  <span class="letter-title-text text-truncate d-block" [title]="letter.title" data-bs-toggle="tooltip"
                    data-bs-placement="top">
                    {{ letter.title }}
                  </span>
                  <small class="text-muted text-truncate d-block" *ngIf="letter.breeif" [title]="letter.breeif">
                    {{ letter.breeif }}
                  </small>
                </div>
              </div>
            </td>
            <td data-label="المرسل">
              <div class="sender-cell">
                <i class="fa fa-user-circle text-primary me-2"></i>
                <span class="text-truncate d-block">{{ letter.user?.fullname || 'غير محدد' }}</span>
              </div>
            </td>
            <td data-label="تاريخ الإنشاء">
              <div class="created-at-cell">
                <i class="fa fa-clock text-info me-2"></i>
                <span>{{ letter.createdAt | date: 'dd/MM/yyyy' }}</span>
              </div>
            </td>
            <td data-label="تاريخ بدء القرار">
              <div class="created-at-cell">
                <i class="fa fa-clock text-info me-2"></i>
                <span>{{ letter.StartDate ? (letter.StartDate | date: 'dd/MM/yyyy') : 'غير محدد' }}</span>
              </div>
            </td>
            <td data-label="تاريخ انتهاء القرار">
              <div class="created-at-cell">
                <i class="fa fa-clock text-info me-2"></i>
                <span>{{ letter.EndDate ? (letter.EndDate | date: 'dd/MM/yyyy') : 'غير محدد' }}</span>
              </div>
            </td>
            <td data-label="الإجراءات">
              <div class="actions-cell">
                <button class="btn btn-primary btn-sm btn-action" (click)="viewLetterDetails(letter._id)"
                  title="عرض التفاصيل">
                  <i class="fa fa-eye"></i>
                  <span class="d-none d-md-inline ms-1">عرض</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

<div *ngIf="showUploadModal && (user?.fullname === 'مكتب رئيس الجامعة' || user?.role === 'UniversityPresident')"  class="modal-overlay" (click)="closeUploadModal()" dir="rtl">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">
          <i class="fa fa-cloud-upload-alt"></i>
        </div>
        <div class="modal-title">
          <h4 class="mb-1 text-truncate">رفع أرشيف جديد</h4>
          <p class="text-muted mb-0 text-truncate">أضف مستنداً جديداً إلى الأرشيف</p>
        </div>
        <button type="button" class="btn-close" (click)="closeUploadModal()">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="uploadArchive()" #archiveForm="ngForm">
          <div class="form-group mb-3">
            <label class="form-label fw-semibold">عنوان المستند <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-lg" [(ngModel)]="newArchive.title" name="title"
              placeholder="مثال: قرار رقم ٢٤٥ لسنة ٢٠٢٣" required />
          </div>
          <div class="form-group mb-3">

          <label class="form-label fw-semibold">رقم القرار <span class="text-danger">*</span></label>
          <input 
            type="text" 
            class="form-control form-control-lg" 
            [(ngModel)]="newArchive.transactionNumber" 
            name="transactionNumber"
            placeholder="مثال: 245/2023" 
            required
          />
        </div>
          <div class="form-group mb-3">
            <label class="form-label fw-semibold">الوصف</label>
            <textarea class="form-control" rows="3" [(ngModel)]="newArchive.description" name="description"
              placeholder="وصف مختصر للمستند..."></textarea>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label class="form-label fw-semibold">تاريخ المستند <span class="text-danger">*</span></label>
                <input type="date" class="form-control" [(ngModel)]="newArchive.date" name="date" required />
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label class="form-label fw-semibold">نوع الأرشيف</label>
                <select class="form-select" [(ngModel)]="newArchive.letterType" name="letterType">
                  <option value="رئاسة الجمهورية">رئاسة الجمهورية</option>
                  <option value="وزارة التعليم العالي">وزارة التعليم العالي</option>
                  <option value="رئاسة الوزراء">رئاسة الوزراء</option>
                  <option value="عامة">عامة</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-group mb-4">
            <label class="form-label fw-semibold">رفع الملف</label>
            <div class="file-upload-area" [class.active]="newArchive.file" [class.has-file]="newArchive.file">
              <input type="file" class="file-input" (change)="onFileSelected($event)" #fileInput
                accept=".pdf,.doc,.docx,.jpg,.png" />
              <div class="upload-placeholder" (click)="fileInput.click()">
                <i class="fa fa-cloud-upload-alt text-muted mb-2"></i>
                <div class="upload-text">
                  <h6 class="mb-1">انقر لرفع الملف</h6>
                  <small class="text-muted">PDF, Word, أو صور - الحد الأقصى 10MB</small>
                </div>
              </div>
              <div class="file-preview" *ngIf="newArchive.file">
                <i class="fa fa-file-pdf text-primary me-2"></i>
                <div class="file-info flex-grow-1">
                  <span class="file-name d-block fw-semibold text-truncate">{{ newArchive.file.name }}</span>
                  <span class="file-size text-muted">{{ getFileSize(newArchive.file.size) }}</span>
                </div>
                <button type="button" class="btn-remove" (click)="removeFile()">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-cancel" (click)="closeUploadModal()">
              <i class="fa fa-times me-2"></i>إلغاء
            </button>
            <button type="submit" class="btn btn-submit" [disabled]="uploading || !archiveForm.form.valid"
              [class.btn-loading]="uploading">
              <span *ngIf="!uploading">
                <i class="fa fa-cloud-upload me-2"></i>رفع الأرشيف
              </span>
              <span *ngIf="uploading">
                <i class="fa fa-spinner fa-spin me-2"></i>جاري الرفع...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>