<div class="container-fluid rtl" dir="rtl">
  <!-- الهيدر المحسن -->
  <div class="page-header">
    <div class="row align-items-center">
      <div class="col-12 col-md-8 col-lg-9">
        <div class="d-flex align-items-center mb-2 mb-md-0">
          <div class="flex-grow-1 min-width-0">
            <h1 class="page-title text-truncate">{{ getArchiveTitle() }}</h1>
            <p class="page-subtitle text-truncate mb-0">{{ getArchiveSubtitle() }}</p>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4 col-lg-3">
        <button class="btn btn-light btn-add" (click)="openUploadModal()" [disabled]="loading">
          <i class="fa fa-plus-circle me-2"></i>
          <span class="d-none d-sm-inline">إضافة مستند جديد</span>
          <span class="d-inline d-sm-none">إضافة</span>
        </button>
      </div>
    </div>
  </div>

  <!-- حالة التحميل -->
  <div *ngIf="loading" class="loading-state">
    <div class="spinner-container">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
      <div class="loading-text">
        <h4>جاري تحميل البيانات</h4>
        <p class="text-muted">يرجى الانتظار...</p>
      </div>
    </div>
  </div>

  <!-- حالة عدم وجود بيانات -->
  <div *ngIf="!loading && letters.length === 0" class="empty-state">
    <div class="empty-icon">
      <i class="fa fa-inbox"></i>
    </div>
    <h3 class="empty-title">لا توجد خطابات</h3>
    <p class="empty-text">لم يتم العثور على أي خطابات في هذا الأرشيف.</p>
    <button *ngIf="isSpecialArchive()" class="btn btn-primary" (click)="openUploadModal()">
      <i class="fa fa-plus me-2"></i>إضافة أول خطاب
    </button>
  </div>

  <!-- جدول الخطابات -->
  <div *ngIf="!loading && letters.length > 0" class="letters-table-container">
    <div class="table-responsive">
      <table class="table table-hover table-striped letters-table">
        <thead class="table-primary">
          <tr>
            <th scope="col" width="5%">#</th>
            <th scope="col" width="25%">عنوان الخطاب</th>
            <th scope="col" width="20%">المرسل</th>
            <th scope="col" width="15%">تاريخ الإنشاء</th>
            <th scope="col" width="10%">الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let letter of letters; let i = index; trackBy: trackByLetterId" class="letter-row">
            <td data-label="#">
              <span class="badge bg-primary">{{ i + 1 }}</span>
            </td>
            <td data-label="عنوان الخطاب">
              <div class="letter-title-cell">
                <i class="fa fa-envelope text-primary me-2"></i>
                <span class="letter-title-text text-truncate d-block" [title]="letter.title" data-bs-toggle="tooltip"
                  data-bs-placement="top">
                  {{ letter.title }}
                </span>
              </div>
            </td>
            <td data-label="المرسل">
              <div class="sender-cell">
                <i class="fa fa-user-circle text-primary me-2"></i>
                <span class="text-truncate d-block">{{ letter.user?.fullname || 'غير محدد' }}</span>
              </div>
            </td>
            <td data-label="تاريخ الإنشاء">
              <div class="created-at-cell">
                <i class="fa fa-clock text-info me-2"></i>
                <span>{{ letter.createdAt | date: 'dd/MM/yyyy' }}</span>
              </div>
            </td>
            <td data-label="الإجراءات">
              <div class="actions-cell">
                <button class="btn btn-primary btn-sm btn-action" (click)="viewLetterDetails(letter._id)"
                  title="عرض التفاصيل">
                  <i class="fa fa-eye"></i>
                  <span class="d-none d-md-inline ms-1">عرض</span>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- المودال المحسن -->
<div *ngIf="showUploadModal" class="modal-overlay" (click)="closeUploadModal()" dir="rtl">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-icon">
          <i class="fa fa-cloud-upload-alt"></i>
        </div>
        <div class="modal-title">
          <h4 class="mb-1 text-truncate">رفع أرشيف جديد</h4>
          <p class="text-muted mb-0 text-truncate">أضف مستنداً جديداً إلى الأرشيف</p>
        </div>
        <button type="button" class="btn-close" (click)="closeUploadModal()">
          <i class="fa fa-times"></i>
        </button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="uploadArchive()" #archiveForm="ngForm">
          <div class="form-group mb-3">
            <label class="form-label fw-semibold">عنوان المستند <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-lg" [(ngModel)]="newArchive.title" name="title"
              placeholder="مثال: قرار رقم ٢٤٥ لسنة ٢٠٢٣" required />
          </div>

          <div class="form-group mb-3">
            <label class="form-label fw-semibold">الوصف</label>
            <textarea class="form-control" rows="3" [(ngModel)]="newArchive.description" name="description"
              placeholder="وصف مختصر للمستند..."></textarea>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label class="form-label fw-semibold">تاريخ المستند <span class="text-danger">*</span></label>
                <input type="date" class="form-control" [(ngModel)]="newArchive.date" name="date" required />
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <div class="form-group">
                <label class="form-label fw-semibold">نوع الأرشيف</label>
                <select class="form-select" [(ngModel)]="newArchive.letterType" name="letterType">
                  <option value="رئاسة الجمهورية">رئاسة الجمهورية</option>
                  <option value="وزارة التعليم العالي">وزارة التعليم العالي</option>
                  <option value="رئاسة الوزراء">رئاسة الوزراء</option>
                  <option value="عامة">عامة</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-group mb-4">
            <label class="form-label fw-semibold">رفع الملف</label>
            <div class="file-upload-area" [class.active]="newArchive.file" [class.has-file]="newArchive.file">
              <input type="file" class="file-input" (change)="onFileSelected($event)" #fileInput
                accept=".pdf,.doc,.docx,.jpg,.png" />
              <div class="upload-placeholder" (click)="fileInput.click()">
                <i class="fa fa-cloud-upload-alt text-muted mb-2"></i>
                <div class="upload-text">
                  <h6 class="mb-1">انقر لرفع الملف</h6>
                  <small class="text-muted">PDF, Word, أو صور - الحد الأقصى 10MB</small>
                </div>
              </div>
              <div class="file-preview" *ngIf="newArchive.file">
                <i class="fa fa-file-pdf text-primary me-2"></i>
                <div class="file-info flex-grow-1">
                  <span class="file-name d-block fw-semibold text-truncate">{{ newArchive.file.name }}</span>
                  <span class="file-size text-muted">{{ getFileSize(newArchive.file.size) }}</span>
                </div>
                <button type="button" class="btn-remove" (click)="removeFile()">
                  <i class="fa fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-cancel" (click)="closeUploadModal()">
              <i class="fa fa-times me-2"></i>إلغاء
            </button>
            <button type="submit" class="btn btn-submit" [disabled]="uploading || !archiveForm.form.valid"
              [class.btn-loading]="uploading">
              <span *ngIf="!uploading">
                <i class="fa fa-cloud-upload me-2"></i>رفع الأرشيف
              </span>
              <span *ngIf="uploading">
                <i class="fa fa-spinner fa-spin me-2"></i>جاري الرفع...
              </span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>