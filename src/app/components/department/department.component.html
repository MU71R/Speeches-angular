<!-- Loading Spinner -->
<div class="loading-container" *ngIf="loading">
  <div class="loading-spinner">
    <div class="loading-spinner-inner">
      <div class="loading-spinner-inner-inner"></div>
    </div>
  </div>
</div>

<!-- محتوى الصفحة -->
<div class="container-fluid" dir="rtl" [class.blur-content]="loading">

  <!-- Tabs -->
  <ul class="nav nav-tabs my-3">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'users'" (click)="activeTab = 'users'">المستخدمون</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'sectors'" (click)="activeTab = 'sectors'">القطاعات</a>
    </li>
  </ul>

  <!-- Users Tab -->
  <div *ngIf="activeTab === 'users'" class="d-flex flex-column gap-3">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-3 mt-2">
      <h2 class="fw-bold m-0">إدارة المستخدمين</h2>
      <button class="btn btn-primary" (click)="openAddDepartment()">
        <i class="fas fa-plus-circle me-2"></i> إضافة مستخدم جديد
      </button>
    </div>

    <!-- Filters -->
    <div class="d-flex flex-column flex-md-row align-items-start gap-2 mb-3">
      <input type="text" class="form-control w-auto" placeholder="البحث عن مستخدم..." [(ngModel)]="searchTerm" (input)="applyFilters()" />
      <select class="form-select w-auto" [(ngModel)]="selectedSector" (change)="applyFilters()">
        <option value="">جميع الأقسام</option>
        <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
      </select>
      <button class="btn btn-outline-secondary" (click)="resetFilters()">
        <i class="fa fa-rotate-left me-1"></i> إعادة تعيين
      </button>
    </div>

    <!-- Users Table -->
    <div class="table-responsive shadow-sm rounded bg-white">
      <table class="table table-hover text-center align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>القسم</th>
            <th>اسم المستخدم</th>
            <th>الاسم الكامل</th>
            <th>الدور</th>
            <th>الحالة</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of filteredList">
            <td>{{ user.sectorName || '---' }}</td>
            <td>{{ user.username || '---' }}</td>
            <td>{{ user.fullname || '---' }}</td>
            <td>
              <span class="badge px-3 py-2"
                [ngClass]="user.role === 'preparer' ? 'bg-primary' :
                           user.role === 'supervisor' ? 'bg-secondary' :
                           user.role === 'UniversityPresident' ? 'bg-success' :
                           'bg-danger'">
                {{ user.role === 'preparer' ? 'مستخدم' :
                   user.role === 'supervisor' ? 'المراجع' :
                   user.role === 'UniversityPresident' ? 'رئيس الجامعة' :
                   'المدير' }}
              </span>
            </td>
            <td>
              <span class="badge px-3 py-2" [ngClass]="user.status === 'active' ? 'bg-success' : 'bg-danger'">
                {{ user.status === 'active' ? 'نشط' : 'معطل' }}
              </span>
            </td>
            <td class="d-flex justify-content-center gap-2">
              <button class="btn btn-sm btn-warning" (click)="openEditUser(user)" title="تعديل المستخدم">
                <i class="fa fa-pencil"></i>
              </button>
              <button class="btn btn-sm btn-success" (click)="toggleStatus(user)" title="تغيير الحالة">
                <i class="fa fa-user-check"></i>
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteUser(user)" title="حذف">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="filteredList.length === 0" class="text-center py-3 text-muted">
        لا يوجد مستخدمون لعرضهم
      </div>
    </div>
  </div>

  <!-- Sectors Tab -->
  <div *ngIf="activeTab === 'sectors'" class="d-flex flex-column gap-3">
    <div class="d-flex justify-content-between align-items-center mb-3 mt-2">
      <h2 class="fw-bold m-0">إدارة القطاعات</h2>
      <button class="btn btn-secondary" (click)="openSectorForm()">
        <i class="fas fa-plus-circle me-2"></i> إضافة قطاع
      </button>
    </div>

    <div class="table-responsive shadow-sm rounded bg-white">
      <table class="table table-hover text-center align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>اسم القطاع</th>
            <th>الإجراءات</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of sectors">
            <td>{{ s.sector }}</td>
            <td class="d-flex justify-content-center gap-2">
              <button class="btn btn-sm btn-warning" (click)="editSector(s)">
                <i class="fa fa-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" (click)="deleteSector(s._id)">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
      <div *ngIf="sectors.length === 0" class="text-center py-3 text-muted">
        لا يوجد قطاعات لعرضها
      </div>
    </div>
  </div>

  <!-- ============== Modals ============== -->

  <!-- Add/Edit User -->
  <div *ngIf="showAddDepartmentModal" class="modal fade show d-block modal-backdrop-custom">
    <div class="modal-dialog">
      <div class="modal-content d-flex flex-column gap-3">
        <div class="modal-header">
          <h5 class="modal-title">{{ newDepartment._id ? 'تعديل المستخدم' : 'إضافة مستخدم جديد' }}</h5>
          <button type="button" class="btn-close" (click)="closeAddDepartment()"></button>
        </div>
        <div class="modal-body d-flex flex-column gap-3">
          <label>القطاع:</label>
          <select class="form-select" [(ngModel)]="newDepartment.sector">
            <option value="" disabled>اختر القطاع</option>
            <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
          </select>

          <label>اسم المستخدم:</label>
          <input class="form-control" [(ngModel)]="newDepartment.username" placeholder="اسم المستخدم" />

          <label>الاسم الكامل:</label>
          <input class="form-control" [(ngModel)]="newDepartment.fullname" placeholder="الاسم الكامل" />

          <label>كلمة المرور:</label>
          <input type="password" class="form-control" [(ngModel)]="newDepartment.password" placeholder="كلمة المرور" />

          <label>الدور:</label>
          <select class="form-select" [(ngModel)]="newDepartment.role">
            <option value="preparer">مستخدم</option>
            <option value="supervisor">المراجع</option>
            <option value="UniversityPresident">رئيس الجامعة</option>
            <option value="admin">المدير</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeAddDepartment()">إلغاء</button>
          <button class="btn btn-primary" (click)="saveDepartment()">حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Sector -->
  <div *ngIf="showSectorForm" class="modal fade show d-block modal-backdrop-custom">
    <div class="modal-dialog">
      <div class="modal-content d-flex flex-column gap-3">
        <div class="modal-header">
          <h5 class="modal-title">{{ newSector._id ? 'تعديل القطاع' : 'إضافة قطاع جديد' }}</h5>
          <button type="button" class="btn-close" (click)="closeSectorForm()"></button>
        </div>
        <div class="modal-body d-flex flex-column gap-3">
          <input class="form-control" [(ngModel)]="newSector.sector" placeholder="اسم القطاع" />
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeSectorForm()">إلغاء</button>
          <button class="btn btn-primary" (click)="saveSector()">حفظ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div *ngIf="showEditUserModal" class="modal fade show d-block modal-backdrop-custom">
    <div class="modal-dialog">
      <div class="modal-content d-flex flex-column gap-3">
        <div class="modal-header">
          <h5 class="modal-title">تعديل المستخدم</h5>
          <button type="button" class="btn-close" (click)="closeEditUser()"></button>
        </div>
        <div class="modal-body d-flex flex-column gap-3">
          <label>القطاع:</label>
          <select class="form-select" [(ngModel)]="selectedUser.sector">
            <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
          </select>
          <label>اسم المستخدم:</label>
          <input class="form-control" [(ngModel)]="selectedUser.username" />
          <label>الاسم الكامل:</label>
          <input class="form-control" [(ngModel)]="selectedUser.fullname" />
          <label>الدور:</label>
          <select class="form-select" [(ngModel)]="selectedUser.role">
            <option value="preparer">مستخدم</option>
            <option value="supervisor">المراجع</option>
            <option value="UniversityPresident">رئيس الجامعة</option>
            <option value="admin">المدير</option>
          </select>
          <label>الحالة:</label>
          <select class="form-select" [(ngModel)]="selectedUser.status">
            <option value="active">نشط</option>
            <option value="inactive">معطل</option>
          </select>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeEditUser()">إلغاء</button>
          <button class="btn btn-primary" (click)="confirmEditUser()">حفظ</button>
        </div>
      </div>
    </div>
  </div>
</div>
