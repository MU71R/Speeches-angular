<div class="loading-container" *ngIf="loading">
  <div class="loading-spinner">
    <div class="loading-spinner-inner">
      <div class="loading-spinner-inner-inner"></div>
    </div>
  </div>
</div>

<div class="container-fluid page-container" dir="rtl" [class.blur-content]="loading">

  <ul class="nav nav-tabs responsive-tabs">
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'users'" (click)="activeTab = 'users'">
        <i class="fas fa-users d-none d-sm-inline me-1"></i>
        <span>المستخدمون</span>
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" [class.active]="activeTab === 'sectors'" (click)="activeTab = 'sectors'">
        <i class="fas fa-building d-none d-sm-inline me-1"></i>
        <span>القطاعات</span>
      </a>
    </li>
  </ul>

  <div *ngIf="activeTab === 'users'" class="tab-content-wrapper">

    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-users me-2"></i>
        إدارة المستخدمين
      </h2>
      <button class="btn btn-primary add-btn" (click)="openAddDepartment()">
        <i class="fas fa-plus-circle me-1 me-md-2"></i>
        <span class="d-none d-md-inline">إضافة مستخدم جديد</span>
        <span class="d-md-none">إضافة</span>
      </button>
    </div>

    <div class="filters-section">
      <div class="search-box">
        <i class="fas fa-search search-icon"></i>
        <input type="text" class="form-control search-input" placeholder="البحث عن مستخدم..." [(ngModel)]="searchTerm"
          (input)="applyFilters()" />
      </div>

      <div class="custom-select-wrapper filter-select">
        <select class="form-select custom-select" [(ngModel)]="selectedSector" (change)="applyFilters()">
          <option value="">جميع الأقسام</option>
          <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
        </select>
        <div class="select-arrow">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>

      <button class="btn btn-outline-secondary reset-btn" (click)="resetFilters()">
        <i class="fa fa-rotate-left me-1"></i>
        <span class="d-none d-sm-inline">إعادة تعيين</span>
      </button>
    </div>

    <div class="table-container">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-header">
            <tr>
              <th class="text-center">القسم</th>
              <th class="text-center">اسم المستخدم</th>
              <th class="text-center">الاسم الكامل</th>
              <th class="text-center">الدور</th>
              <th class="text-center">الحالة</th>
              <th class="text-center">الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let user of filteredList" class="table-row">
              <td class="text-center" data-label="القسم">{{ user.sectorName || '---' }}</td>
              <td class="text-center" data-label="اسم المستخدم">{{ user.username || '---' }}</td>
              <td class="text-center" data-label="الاسم الكامل">{{ user.fullname || '---' }}</td>
              <td class="text-center" data-label="الدور">
                <span class="badge role-badge" [ngClass]="user.role === 'preparer' ? 'bg-primary' :
                           user.role === 'supervisor' ? 'bg-secondary' :
                           user.role === 'UniversityPresident' ? 'bg-success' :
                           'bg-danger'">
                  {{ user.role === 'preparer' ? 'مستخدم' :
                  user.role === 'supervisor' ? 'المراجع' :
                  user.role === 'UniversityPresident' ? 'رئيس الجامعة' :
                  'المدير' }}
                </span>
              </td>
              <td class="text-center" data-label="الحالة">
                <span class="badge status-badge" [ngClass]="user.status === 'active' ? 'bg-success' : 'bg-danger'">
                  {{ user.status === 'active' ? 'نشط' : 'معطل' }}
                </span>
              </td>
              <td class="text-center actions-cell" data-label="الإجراءات">
                <div class="actions-wrapper">
                  <button class="btn btn-sm btn-warning action-btn" (click)="openEditUser(user)" title="تعديل المستخدم">
                    <i class="fa fa-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-success action-btn" (click)="toggleStatus(user)" title="تغيير الحالة">
                    <i class="fa fa-user-check"></i>
                  </button>
                  <button class="btn btn-sm btn-danger action-btn" (click)="deleteUser(user)" title="حذف">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="filteredList.length === 0" class="empty-state">
        <i class="fas fa-users empty-icon"></i>
        <p class="empty-text">لا يوجد مستخدمون لعرضهم</p>
      </div>
    </div>
  </div>

  <div *ngIf="activeTab === 'sectors'" class="tab-content-wrapper">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-building me-2"></i>
        إدارة القطاعات
      </h2>
      <button class="btn btn-secondary add-btn" (click)="openSectorForm()">
        <i class="fas fa-plus-circle me-1 me-md-2"></i>
        <span class="d-none d-md-inline">إضافة قطاع</span>
        <span class="d-md-none">إضافة</span>
      </button>
    </div>

    <div class="table-container">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-header">
            <tr>
              <th class="text-center">اسم القطاع</th>
              <th class="text-center">الإجراءات</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let s of sectors" class="table-row">
              <td class="text-center" data-label="اسم القطاع">{{ s.sector }}</td>
              <td class="text-center actions-cell" data-label="الإجراءات">
                <div class="actions-wrapper">
                  <button class="btn btn-sm btn-warning action-btn" (click)="editSector(s)">
                    <i class="fa fa-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger action-btn" (click)="deleteSector(s._id)">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div *ngIf="sectors.length === 0" class="empty-state">
        <i class="fas fa-building empty-icon"></i>
        <p class="empty-text">لا يوجد قطاعات لعرضها</p>
      </div>
    </div>
  </div>

  <div *ngIf="showAddDepartmentModal" class="modal-backdrop-custom">
    <div class="modal-center-container">
      <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content custom-modal">
          <div class="modal-header modal-header-custom">
            <h5 class="modal-title">
              <i class="fas fa-user-plus me-2"></i>
              إضافة مستخدم جديد
            </h5>
            <button type="button" class="btn-close-custom" (click)="closeAddDepartment()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form class="modal-form">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">القطاع <span class="text-danger">*</span></label>
                    <div class="custom-select-wrapper">
                      <select class="form-control form-control-custom custom-select" [(ngModel)]="newDepartment.sector"
                        name="sector" required>
                        <option value="" disabled selected>اختر القطاع</option>
                        <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
                      </select>
                      <div class="select-arrow">
                        <i class="fas fa-chevron-down"></i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">اسم المستخدم <span class="text-danger">*</span></label>
                    <input class="form-control form-control-custom" [(ngModel)]="newDepartment.username" name="username"
                      placeholder="اسم المستخدم" required />
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">الاسم الكامل <span class="text-danger">*</span></label>
                    <input class="form-control form-control-custom" [(ngModel)]="newDepartment.fullname" name="fullname"
                      placeholder="الاسم الكامل" required />
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">الدور <span class="text-danger">*</span></label>
                    <div class="custom-select-wrapper">
                      <select class="form-control form-control-custom custom-select" [(ngModel)]="newDepartment.role"
                        name="role" required>
                        <option value="preparer">مستخدم</option>
                        <option value="supervisor">المراجع</option>
                        <option value="UniversityPresident">رئيس الجامعة</option>
                        <option value="admin">المدير</option>
                      </select>
                      <div class="select-arrow">
                        <i class="fas fa-chevron-down"></i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12">
                  <div class="form-group">
                    <label class="form-label">كلمة المرور <span class="text-danger">*</span></label>
                    <div class="password-input-group">
                      <input [type]="showPassword ? 'text' : 'password'"
                        class="form-control form-control-custom password-field" [(ngModel)]="newDepartment.password"
                        name="password" placeholder="كلمة المرور" required />
                      <button type="button" class="password-toggle-btn" (click)="togglePassword('add')">
                        <i class="fa" [class.fa-eye]="!showPassword" [class.fa-eye-slash]="showPassword"></i>
                      </button>
                    </div>
                    <div class="form-text">يجب أن تحتوي كلمة المرور على 8 أحرف على الأقل</div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer modal-footer-custom">
            <button class="btn btn-cancel" (click)="closeAddDepartment()">إلغاء</button>
            <button class="btn btn-save" (click)="saveDepartment()">
              <i class="fas fa-save me-2"></i> حفظ المستخدم
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showSectorForm" class="modal-backdrop-custom">
    <div class="modal-center-container">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content custom-modal">
          <div class="modal-header modal-header-custom">
            <h5 class="modal-title">
              <i class="fas fa-building me-2"></i>
              {{ newSector._id ? 'تعديل القطاع' : 'إضافة قطاع جديد' }}
            </h5>
            <button type="button" class="btn-close-custom" (click)="closeSectorForm()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <form class="modal-form">
              <div class="form-group">
                <label class="form-label">اسم القطاع <span class="text-danger">*</span></label>
                <input class="form-control form-control-custom" [(ngModel)]="newSector.sector" name="sector"
                  placeholder="اسم القطاع" required />
              </div>
            </form>
          </div>
          <div class="modal-footer modal-footer-custom">
            <button class="btn btn-cancel" (click)="closeSectorForm()">إلغاء</button>
            <button class="btn btn-save" (click)="saveSector()">
              <i class="fas fa-save me-2"></i> حفظ القطاع
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="showEditUserModal" class="modal-backdrop-custom">
    <div class="modal-center-container">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content custom-modal">
          <div class="modal-header modal-header-custom">
            <h5 class="modal-title">
              <i class="fas fa-user-edit me-2"></i>
              تعديل المستخدم
            </h5>
            <button type="button" class="btn-close-custom" (click)="closeEditUser()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="modal-body">
            <div class="card password-card mb-4">
              <div class="card-header password-card-header" (click)="showEditPassword = !showEditPassword">
                <h6 class="mb-0 d-flex align-items-center justify-content-between">
                  <span>
                    <i class="fa fa-key me-2"></i>
                    تغيير كلمة المرور
                  </span>
                  <i class="fa transition-icon" [class.fa-chevron-down]="!showEditPassword"
                    [class.fa-chevron-up]="showEditPassword"></i>
                </h6>
              </div>
              <div class="card-body password-card-body" *ngIf="showEditPassword">
                <div class="alert alert-info info-alert">
                  <i class="fas fa-info-circle me-2"></i>
                  سيتم تحديث كلمة المرور مباشرة بدون التحقق من كلمة المرور الحالية
                </div>
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <div class="form-group">
                      <label class="form-label">كلمة المرور الجديدة</label>
                      <div class="password-input-group">
                        <input [type]="showNewPassword ? 'text' : 'password'"
                          class="form-control form-control-custom password-field"
                          [(ngModel)]="editPasswordData.newPassword" placeholder="كلمة المرور الجديدة" />
                        <button type="button" class="password-toggle-btn" (click)="togglePassword('new')">
                          <i class="fa" [class.fa-eye]="!showNewPassword" [class.fa-eye-slash]="showNewPassword"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <div class="form-group">
                      <label class="form-label">تأكيد كلمة المرور الجديدة</label>
                      <div class="password-input-group">
                        <input type="password" class="form-control form-control-custom password-field"
                          [(ngModel)]="editPasswordData.confirmPassword" placeholder="تأكيد كلمة المرور الجديدة" />
                      </div>
                    </div>
                  </div>
                  <div class="col-12">
                    <button class="btn btn-change-password" (click)="changePassword()">
                      <i class="fa fa-key me-2"></i> تحديث كلمة المرور
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <h6 class="section-title mb-3">
              <i class="fas fa-user-circle me-2"></i>
              بيانات المستخدم
            </h6>
            <form class="modal-form">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">القطاع</label>
                    <div class="custom-select-wrapper">
                      <select class="form-control form-control-custom custom-select" [(ngModel)]="selectedUser.sector"
                        name="editSector">
                        <option *ngFor="let s of sectors" [value]="s._id">{{ s.sector }}</option>
                      </select>
                      <div class="select-arrow">
                        <i class="fas fa-chevron-down"></i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">اسم المستخدم</label>
                    <input class="form-control form-control-custom" [(ngModel)]="selectedUser.username"
                      name="editUsername" />
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">الاسم الكامل</label>
                    <input class="form-control form-control-custom" [(ngModel)]="selectedUser.fullname"
                      name="editFullname" />
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">الدور</label>
                    <div class="custom-select-wrapper">
                      <select class="form-control form-control-custom custom-select" [(ngModel)]="selectedUser.role"
                        name="editRole">
                        <option value="preparer">مستخدم</option>
                        <option value="supervisor">المراجع</option>
                        <option value="UniversityPresident">رئيس الجامعة</option>
                        <option value="admin">المدير</option>
                      </select>
                      <div class="select-arrow">
                        <i class="fas fa-chevron-down"></i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 col-md-6">
                  <div class="form-group">
                    <label class="form-label">الحالة</label>
                    <div class="custom-select-wrapper">
                      <select class="form-control form-control-custom custom-select" [(ngModel)]="selectedUser.status"
                        name="editStatus">
                        <option value="active">نشط</option>
                        <option value="inactive">معطل</option>
                      </select>
                      <div class="select-arrow">
                        <i class="fas fa-chevron-down"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer modal-footer-custom">
            <button class="btn btn-cancel" (click)="closeEditUser()">إلغاء</button>
            <button class="btn btn-save" (click)="confirmEditUser()">
              <i class="fas fa-save me-2"></i> حفظ التعديلات
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>