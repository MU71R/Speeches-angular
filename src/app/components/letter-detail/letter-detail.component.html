<div class="container-fluid py-4" *ngIf="!loading; else loadTpl" dir="rtl">
  <div class="card shadow-lg border-0 rounded-3 overflow-hidden">
    <!-- Header -->
    <div class="card-header bg-gradient-primary text-white py-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="flex-grow-1">
          <h3 class="fw-bold mb-2">{{ form.value.title || 'تفاصيل الخطاب' }}</h3>
          <p class="mb-0 opacity-85">معلومات تفصيلية عن الخطاب وحالة المعالجة</p>
        </div>
        <div class="d-flex gap-3">
          <button *ngIf="!isEditing" class="btn btn-light btn-lg px-4 rounded-2" (click)="enableEdit()">
            <i class="bi bi-pencil-square me-2"></i> تعديل
          </button>
          <div *ngIf="isEditing" class="d-flex gap-2">
            <button class="btn btn-success btn-lg px-4 rounded-2" (click)="saveChanges()" [disabled]="processing">
              <i class="bi bi-check-lg me-2"></i> حفظ
            </button>
            <button class="btn btn-outline-light btn-lg px-4 rounded-2" (click)="cancelEdit()">
              <i class="bi bi-x-lg me-2"></i> إلغاء
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Body -->
    <div class="card-body p-4">
      <div class="row g-4">
        <!-- معلومات الخطاب -->
        <div class="col-lg-6">
          <div class="border-end-lg pe-lg-4">
            <h5 class="fw-bold text-primary mb-4 d-flex align-items-center gap-2">
              <i class="bi bi-info-circle"></i>
              معلومات الخطاب
            </h5>

            <!-- معلومات أساسية -->
            <div class="row g-3 mb-4">
              <div class="col-md-4">
                <div class="bg-light rounded-2 p-3 h-100">
                  <small class="text-muted d-block mb-2">نوع القرار</small>
                  <div class="fw-bold text-dark">{{ original?.decision?.title || '---' }}</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="bg-light rounded-2 p-3 h-100">
                  <small class="text-muted d-block mb-2">الجهة المعدة</small>
                  <div class="fw-bold text-dark">{{ original?.user?.fullname || '---' }}</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="bg-light rounded-2 p-3 h-100">
                  <small class="text-muted d-block mb-2">الحالة</small>
                  <span [class]="getStatusBadgeClass(original?.status || '')" class="badge fw-semibold">
                    {{ getStatusText(original?.status || '') }}
                  </span>
                </div>
              </div>
            </div>

            <!-- التوقيتات -->
            <div class="row g-3 mb-4">
              <div class="col-md-6">
                <div class="bg-light rounded-2 p-3 h-100">
                  <small class="text-muted d-block mb-2">تاريخ الإنشاء</small>
                  <div class="fw-bold text-dark d-flex align-items-center gap-2">
                    <i class="bi bi-calendar3 text-primary"></i>
                    {{ original?.createdAt | date: 'd MMMM y, h:mm a' }}
                  </div>
                </div>
              </div>
            </div>

            <!-- محتوى الخطاب -->
            <div class="mb-4">
              <h6 class="fw-semibold text-dark mb-3 d-flex align-items-center gap-2">
                <i class="bi bi-file-text text-primary"></i>
                محتوى الخطاب
              </h6>
              <div *ngIf="!isEditing" class="border rounded-3 p-4 bg-light min-h-200" [innerHTML]="previewHtml"></div>
              <div *ngIf="isEditing" [formGroup]="form">
                <textarea class="form-control rounded-3 border-2" rows="10" formControlName="description"
                  placeholder="اكتب محتوى الخطاب هنا..." (input)="onDescriptionChange()"
                  style="border-color: #e9ecef; resize: vertical;"></textarea>
                <small class="text-muted mt-2 d-block">يمكنك استخدام تنسيق HTML للمحتوى</small>
              </div>
            </div>
          </div>
        </div>

        <!-- إجراءات المراجعة -->
        <div class="col-lg-6">
          <h5 class="fw-bold text-primary mb-4 d-flex align-items-center gap-2">
            <i class="bi bi-gear"></i>
            إجراءات المراجعة
          </h5>

          <!-- مسار المعالجة -->
          <div class="mb-5">
            <h6 class="fw-semibold text-dark mb-3">مسار المعالجة</h6>
            <div class="process-track">
              <div class="process-step" [class.active]="getStepClass(1) === 'active'"
                [class.completed]="getStepClass(1) === 'completed'">
                <div class="step-indicator">
                  <i class="bi bi-building"></i>
                </div>
                <div class="step-content">
                  <div class="step-title">الإدارة العامة</div>
                  <div class="step-status">مرحلة المراجعة الأولية</div>
                </div>
              </div>

              <div class="process-step" [class.active]="getStepClass(2) === 'active'"
                [class.completed]="getStepClass(2) === 'completed'">
                <div class="step-indicator">
                  <i class="bi bi-person-badge"></i>
                </div>
                <div class="step-content">
                  <div class="step-title">رئيس الجامعة</div>
                  <div class="step-status">مرحلة الموافقة النهائية</div>
                </div>
              </div>

              <div class="process-step" [class.active]="getStepClass(3) === 'active'"
                [class.completed]="getStepClass(3) === 'completed'">
                <div class="step-indicator">
                  <i class="bi bi-archive"></i>
                </div>
                <div class="step-content">
                  <div class="step-title">الأرشيف</div>
                  <div class="step-status">مرحلة الحفظ النهائي</div>
                </div>
              </div>
            </div>
          </div>

          <!-- قسم الإجراءات -->
          <div *ngIf="showReviewActions()" class="border rounded-3 p-4 bg-light mb-4">
            <h6 class="fw-semibold text-dark mb-3">إجراءات المراجعة</h6>

            <div class="mb-4">
              <label class="form-label fw-semibold text-dark">ملاحظات المراجعة</label>
              <textarea class="form-control rounded-2 border-2" rows="3" [(ngModel)]="reviewNotes"
                placeholder="أدخل ملاحظاتك حول الخطاب..." style="border-color: #dee2e6;"></textarea>
            </div>

            <!-- أزرار المراجع -->
            <div *ngIf="currentUserRole === 'supervisor' && original?.status === 'in_progress'" class="d-grid gap-3">
              <button class="btn btn-danger btn-lg rounded-2 py-3 fw-semibold" (click)="rejectLetter()"
                [disabled]="processing">
                <i class="bi bi-x-circle me-2"></i> رفض الخطاب
              </button>
              <button class="btn btn-success btn-lg rounded-2 py-3 fw-semibold" (click)="approveLetter()"
                [disabled]="processing">
                <i class="bi bi-check-circle me-2"></i> موافقة
              </button>
            </div>

            <!-- أزرار رئيس الجامعة -->
            <div *ngIf="currentUserRole === 'UniversityPresident' && original?.status === 'pending'">
              <div *ngIf="!showPresidentOptions" class="d-grid gap-3">
                <button class="btn btn-danger btn-lg rounded-2 py-3 fw-semibold" (click)="rejectLetter()"
                  [disabled]="processing">
                  <i class="bi bi-x-circle me-2"></i> رفض الخطاب
                </button>
                <button class="btn btn-success btn-lg rounded-2 py-3 fw-semibold" (click)="showPresidentOptions = true"
                  [disabled]="processing">
                  <i class="bi bi-check-circle me-2"></i> موافقة على الخطاب
                </button>
              </div>

              <!-- خيارات الموافقة -->
              <div *ngIf="showPresidentOptions" class="d-grid gap-3">
                <button class="btn btn-success btn-lg rounded-2 py-3 fw-semibold" (click)="approveLetter('حقيقية')"
                  [disabled]="processing">
                  <i class="bi bi-qr-code-scan me-2"></i> موافقة باستخدام Real Scan
                </button>
                <button class="btn btn-outline-primary btn-lg rounded-2 py-3 fw-semibold"
                  (click)="approveLetter('الممسوحة ضوئيا')" [disabled]="processing">
                  <i class="bi bi-pen-fill me-2"></i> موافقة بالتوقيع الإلكتروني
                </button>
                <button class="btn btn-outline-secondary btn-lg rounded-2 py-3" (click)="showPresidentOptions = false">
                  <i class="bi bi-arrow-right me-2"></i> رجوع
                </button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #loadTpl>
  <div class="d-flex justify-content-center align-items-center min-vh-50">
    <div class="text-center">
      <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
      </div>
      <p class="text-muted fw-semibold">جاري تحميل تفاصيل الخطاب...</p>
    </div>
  </div>
</ng-template>